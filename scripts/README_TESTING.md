# تست شبیه‌ساز USB Serial (پایتون)

فایل **`usb_serial_simulator.py`** سه حالت دارد:
- **شبیه‌ساز** (پیش‌فرض): نقش میکرو را بازی می‌کند و روی یک پورت گوش می‌دهد.
- **کلاینت تست** (با `--test`): روی پورت دیگر درخواست می‌فرستد و پاسخ را چک می‌کند.
- **لیست پورت‌ها** (با `--list`): پورت‌های سریال موجود را نمایش می‌دهد.

برای تست بدون سخت‌افزار به **یک جفت پورت سریال مجازی** نیاز دارید.

---

## ۱. نصب وابستگی

```bash
pip install pyserial
```

---

## ۲. راه‌اندازی پورت مجازی

### ویندوز (com0com)

1. **نصب com0com**  
   از [سایت com0com](https://sourceforge.net/projects/com0com/) نسخهٔ ویندوز را دانلود و نصب کنید.

2. **ساخت جفت پورت**  
   بعد از نصب، برنامه **Setup** را اجرا کنید و یک جفت پورت اضافه کنید (مثلاً **COM3** و **COM4**). این دو پورت به هم وصل مجازی می‌شوند؛ هرچه روی یکی بنویسی روی دیگری خوانده می‌شود.

### لینوکس (socat)

در ترمینال:

```bash
socat -d -d pty,raw,echo=0 pty,raw,echo=0
```

خروجی دو مسیر شبیه `/dev/pts/2` و `/dev/pts/3` می‌دهد. یکی را به شبیه‌ساز و یکی را به کلاینت تست بدهید.

### مک

می‌توانید از **socat** یا ابزارهای مشابه برای ساخت دو پورت مجازی متصل به هم استفاده کنید.

---

## ۳. تست شبیه‌ساز با کلاینت تست (همان فایل، حالت --test)

با فرض اینکه پورت مجازی شما **COM3** و **COM4** است (در لینوکس از مسیرهای `pts` استفاده کنید):

**ترمینال ۱ – اجرای شبیه‌ساز:**

```bash
cd scripts
python usb_serial_simulator.py COM3
```

باید ببینید:  
`Simulator running. @M_F_A=floors, @M_R=rooms, &M_F_N=create floor. Ctrl+C to exit.`

**ترمینال ۲ – اجرای کلاینت تست (همان اسکریپت با --test):**

```bash
cd scripts
python usb_serial_simulator.py --test COM4
```

اگر همه‌چیز درست باشد، در ترمینال کلاینت:
- درخواست طبقات و چاپ پاسخ
- درخواست اتاق‌ها و چاپ پاسخ  
و در آخر:  
`Result: 2 passed, 0 failed`

در ترمینال شبیه‌ساز هم لاگ‌های ارسال پاسخ را می‌بینید.

---

## ۴. تست با اپ Flutter (وقتی اپ به یک پورت وصل است)

اگر **اپ فلاتر الان به COM5 وصل است**، فقط یک پورت دارید و اپ آن را باز کرده؛ شبیه‌ساز نمی‌تواند هم‌زمان همان پورت را باز کند. باید از **جفت پورت مجازی** استفاده کنید:

1. **نصب com0com** و ساخت یک جفت پورت (مثلاً **COM4** و **COM5**).
2. در اپ فلاتر پورت **COM5** را انتخاب و اتصال بزنید (همان کاری که الان کردید).
3. در یک **ترمینال** شبیه‌ساز را روی **پورت دیگر همان جفت** اجرا کنید:
   ```bash
   cd scripts
   python usb_serial_simulator.py COM4
   ```
4. در اپ دکمه‌های **«دریافت طبقات»** و **«دریافت اتاق‌ها»** (یا معادل آن‌ها) را بزنید.
5. باید دادهٔ شبیه‌ساز (طبقه اول، اتاق نشیمن، آشپزخانه و …) در اپ نمایش داده شود و در ترمینال شبیه‌ساز لاگ ارسال پاسخ دیده شود.

**جمع‌بندی:** اپ → COM5، شبیه‌ساز → COM4 (جفت مجازی COM4–COM5).

---

## ۵. تست با اپ Flutter (سخت‌افزار واقعی – تبلت + مبدل)

وقتی می‌خواهید اپ سودان را روی **تبلت** با شبیه‌ساز روی لپ‌تاپ تست کنید:

1. **تبلت اندروید** را با کابل **USB OTG** به یک **مبدل USB-Serial** (مثلاً CH340) وصل کنید.
2. طرف دیگر مبدل را به لپ‌تاپ وصل کنید تا در لپ‌تاپ یک پورت (مثلاً COM5) دیده شود.
3. روی لپ‌تاپ شبیه‌ساز را روی همان پورت اجرا کنید:
   ```bash
   python usb_serial_simulator.py COM5
   ```
4. در اپ سودان به صفحه **اتصال سریال** بروید، دستگاه USB را انتخاب و اتصال بزنید.
5. درخواست «تعداد طبقات» یا «لیست طبقات» را بزنید؛ اگر اتصال و پروتکل درست باشد، دادهٔ طبقات/اتاق‌ها از همین شبیه‌ساز می‌آید و در اپ نمایش داده می‌شود.

---

## ۶. تست فقط با یک پورت (لوپ‌بک)

اگر فقط **یک** پورت سریال دارید و **com0com** یا **socat** ندارید:

- می‌توانید با یک برنامهٔ ترمینال سریال (مثلاً PuTTY، Serial Monitor و غیره) به همان پورتی که شبیه‌ساز روی آن گوش می‌دهد وصل شوید؛ اما در آن حالت دو برنامه هم‌زمان نمی‌توانند همان یک پورت را باز کنند، پس این روش برای تست هم‌زمان شبیه‌ساز و کلاینت کافی نیست. برای تست راحت، استفاده از جفت پورت مجازی (بخش ۲ و ۳) بهتر است.

---

## خلاصه دستورات (ویندوز با com0com)

| مرحله        | دستور |
|-------------|--------|
| نصب وابستگی | `pip install pyserial` |
| لیست پورت‌ها | `python usb_serial_simulator.py --list` |
| شبیه‌ساز    | `python usb_serial_simulator.py COM3` |
| کلاینت تست  | `python usb_serial_simulator.py --test COM4` |

بعد از اجرای هر دو، خروجی کلاینت باید شامل دو تست موفق (طبقات و اتاق‌ها) باشد.

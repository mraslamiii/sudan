# تست شبیه‌ساز USB Serial (پایتون) — ویندوز

این راهنما فقط برای **ویندوز** است.

## پیش‌نیازها

| مورد | توضیح |
|------|--------|
| **Python** | نصب Python 3 و pip |
| **pyserial** | `pip install pyserial` |
| **com0com** | نصب از [سایت com0com](https://sourceforge.net/projects/com0com/) و ساخت یک جفت پورت (مثلاً COM5 و COM6) |
| **درایور com0com** | در Device Manager نباید روی جفت پورت آیکن زرد (خطا) باشد. در صورت خطای امضای درایور (کد ۵۲) یک بار با **Disable driver signature enforcement** (F7 در Startup Settings) ریستارت و درایور را آپدیت کنید. |

### چه زمانی از جفت مجازی (com0com) استفاده کنیم؟

| سناریو | پورت‌ها | توضیح |
|--------|--------|--------|
| **اپ روی لپ‌تاپ** (یا امولاتور) + شبیه‌ساز روی لپ‌تاپ | **هر دو پورت مجازی** (com0com)، مثلاً COM5 و COM6 | اپ یک پورت را باز می‌کند، شبیه‌ساز پورت دیگر را. هر دو روی یک ماشین هستند پس به جفت مجازی نیاز دارید. |
| **اپ روی تبلت واقعی** + تبلت با **یک کابل** به لپ‌تاپ (حالت دیباگ) | **اتصال TCP روی پورت ۹۹۹۹** + adb reverse | com0com لازم نیست. شبیه‌ساز با `--tcp 9999` اجرا می‌شود؛ روی لپ‌تاپ یک بار `adb reverse tcp:9999 tcp:9999`؛ در اپ گزینه «اتصال دیباگ (تبلت → لپ‌تاپ)» را بزنید. |
| **اپ روی تبلت واقعی** + تبلت با کابل/مبدل USB-Serial به لپ‌تاپ | **فقط یک پورت فیزیکی** روی لپ‌تاپ | مبدل USB-Serial به تبلت و لپ‌تاپ وصل است؛ لپ‌تاپ یک COM می‌بیند. شبیه‌ساز روی همان یک پورت اجرا می‌شود. com0com لازم نیست. |

---

## روش سریع: اسکریپت همه‌کاره

اگر com0com و pyserial نصب است و جفت پورت بدون خطا کار می‌کند، یک دستور همه‌چیز را انجام می‌دهد:

```bash
cd scripts
python run_all_tests.py
```

این اسکریپت به ترتیب:
1. جفت پورت com0com را پیدا می‌کند (یا از COM5/COM6 استفاده می‌کند).
2. شبیه‌ساز را روی یک پورت اجرا می‌کند.
3. کلاینت تست را روی پورت دیگر اجرا می‌کند و نتیجه را گزارش می‌دهد.
4. در پایان شبیه‌ساز را خاموش می‌کند.

**اجرای تست + اپ Flutter:**

```bash
python run_all_tests.py --launch-app
```

**فقط لیست پورت‌ها:**

```bash
python run_all_tests.py --list
```

---

## فایل‌های تست

- **`usb_serial_simulator.py`** — شبیه‌ساز میکرو و کلاینت تست:
  - **شبیه‌ساز** (پیش‌فرض): روی یک پورت گوش می‌دهد.
  - **کلاینت تست** (با `--test`): روی پورت دیگر درخواست می‌فرستد و پاسخ را چک می‌کند.
  - **لیست پورت‌ها** (با `--list`): پورت‌های سریال موجود را نمایش می‌دهد.

- **`run_all_tests.py`** — اجرای خودکار شبیه‌ساز + کلاینت تست (و اختیاری اپ).

---

## تست با تبلت واقعی + یک کابل (حالت دیباگ)

وقتی **تبلت با یک کابل USB به لپ‌تاپ وصل است** (برای دیباگ با `flutter run`) و می‌خواهید هم‌زمان به شبیه‌ساز روی لپ‌تاپ وصل شوید، از **اتصال TCP + adb reverse** استفاده کنید. com0com یا مبدل USB-Serial لازم نیست.

**مراحل:**

1. **روی لپ‌تاپ** شبیه‌ساز را در حالت TCP اجرا کنید:
   ```bash
   cd scripts
   python usb_serial_simulator.py --tcp 9999
   ```

2. **روی لپ‌تاپ** یک بار دستور زیر را بزنید (تبلت باید با کابل وصل باشد):
   ```bash
   adb reverse tcp:9999 tcp:9999
   ```

3. اپ را روی تبلت اجرا کنید (`flutter run` یا Run از IDE).

4. در اپ به صفحه **اتصال سریال** بروید و دکمه **«اتصال دیباگ (تبلت → لپ‌تاپ)»** را بزنید.

در این حالت ترافیک از اپ (تبلت) به `127.0.0.1:9999` می‌رود و با adb reverse به پورت ۹۹۹۹ روی لپ‌تاپ هدایت می‌شود و شبیه‌ساز پاسخ می‌دهد.

---

## ۱. نصب وابستگی

```bash
pip install pyserial
```

---

## ۲. راه‌اندازی پورت مجازی (com0com)

1. **نصب com0com**  
   از [سایت com0com](https://sourceforge.net/projects/com0com/) نسخهٔ ویندوز را دانلود و نصب کنید.

2. **ساخت جفت پورت**  
   بعد از نصب، برنامه **Setup** را اجرا کنید و یک جفت پورت اضافه کنید (مثلاً **COM5** و **COM6**). این دو پورت به هم وصل مجازی می‌شوند.

3. **رفع خطای امضای درایور (در صورت نیاز)**  
   اگر در Device Manager آیکن زرد دیدید (کد ۵۲)، یک بار با **Recovery → Advanced startup → Restart** و سپس **F7 (Disable driver signature enforcement)** ریستارت کنید و دوباره درایور را آپدیت کنید.

---

## ۳. تست دستی: شبیه‌ساز + کلاینت تست

با فرض جفت پورت **COM5** و **COM6** (شبیه‌ساز روی COM6، کلاینت/اپ روی COM5):

**ترمینال ۱ – اجرای شبیه‌ساز:**

```bash
cd scripts
python usb_serial_simulator.py COM6
```

باید ببینید:  
`Simulator running. @M_F_A=floors, @M_R=rooms, ... Ctrl+C to exit.`

**ترمینال ۲ – اجرای کلاینت تست:**

```bash
cd scripts
python usb_serial_simulator.py --test COM5
```

اگر همه‌چیز درست باشد:  
`Result: 2 passed, 0 failed`

---

## ۴. تست با اپ Flutter (جفت پورت مجازی)

اپ روی یک سر جفت و شبیه‌ساز روی سر دیگر:

1. **com0com** را نصب کرده و یک جفت پورت (مثلاً **COM5** و **COM6**) ساخته باشید.
2. در یک **ترمینال** شبیه‌ساز را اجرا کنید:
   ```bash
   cd scripts
   python usb_serial_simulator.py COM6
   ```
3. در **اپ فلاتر** پورت **COM5** را انتخاب و اتصال بزنید.
4. در اپ دکمه‌های **«دریافت طبقات»** و **«دریافت اتاق‌ها»** را بزنید.
5. دادهٔ شبیه‌ساز در اپ نمایش داده می‌شود و در ترمینال شبیه‌ساز لاگ دیده می‌شود.

**جمع‌بندی:** اپ → COM5، شبیه‌ساز → COM6 (جفت مجازی COM5–COM6).

---

## ۵. تست با اپ روی تبلت واقعی (تبلت + لپ‌تاپ با کابل)

وقتی **اپ روی تبلت** اجرا می‌شود و تبلت با کابل به لپ‌تاپ وصل است:

- **com0com لازم نیست.** فقط **یک پورت فیزیکی** روی لپ‌تاپ دارید (همان پورتی که با اتصال تبلت/مبدل ظاهر می‌شود).
- **هر دو پورت مجازی نیستند** — یکی پورت واقعی است که لپ‌تاپ می‌بیند، اپ روی تبلت به دستگاه USB که به تبلت وصل است وصل می‌شود.

**اتصال صحیح:**

1. **تبلت** را با کابل **USB OTG** به یک **مبدل USB-Serial** (مثلاً CH340) وصل کنید.
2. **طرف دیگر مبدل** را به **لپ‌تاپ** وصل کنید تا در لپ‌تاپ **یک** پورت COM (مثلاً COM5 یا COM7) دیده شود.
3. روی **لپ‌تاپ** شبیه‌ساز را روی **همان یک پورت** اجرا کنید (همان عددی که در Device Manager یا `python usb_serial_simulator.py --list` می‌بینید):
   ```bash
   cd scripts
   python usb_serial_simulator.py COM5
   ```
   (اگر پورت شما مثلاً COM7 بود، همان را بگذارید.)
4. در **اپ روی تبلت** به صفحه **اتصال سریال** بروید، دستگاه USB (مبدل) را انتخاب و اتصال بزنید.
5. درخواست «تعداد طبقات» یا «لیست طبقات» را بزنید؛ داده از شبیه‌ساز روی لپ‌تاپ به تبلت می‌رود.

**جمع‌بندی:** در این حالت فقط **یک پورت** روی لپ‌تاپ (فیزیکی)، شبیه‌ساز روی همان پورت، اپ روی تبلت به همان مبدل وصل است. جفت مجازی (com0com) برای این سناریو استفاده نمی‌شود.

---

## ۶. تست فقط با یک پورت (لوپ‌بک)

اگر فقط **یک** پورت سریال دارید و **com0com** نصب نیست:

- می‌توانید با یک برنامهٔ ترمینال سریال (مثلاً PuTTY، Serial Monitor و غیره) به همان پورتی که شبیه‌ساز روی آن گوش می‌دهد وصل شوید؛ اما در آن حالت دو برنامه هم‌زمان نمی‌توانند همان یک پورت را باز کنند، پس این روش برای تست هم‌زمان شبیه‌ساز و کلاینت کافی نیست. برای تست راحت، استفاده از جفت پورت مجازی (بخش ۲ و ۳) بهتر است.

---

## خلاصه دستورات

| مرحله           | دستور |
|-----------------|--------|
| **تست خودکار**  | `python run_all_tests.py` |
| تست + اجرای اپ | `python run_all_tests.py --launch-app` |
| لیست پورت‌ها    | `python run_all_tests.py --list` یا `python usb_serial_simulator.py --list` |
| نصب وابستگی     | `pip install pyserial` |
| شبیه‌ساز (COM)  | `python usb_serial_simulator.py COM6` |
| **شبیه‌ساز TCP (دیباگ تبلت)** | `python usb_serial_simulator.py --tcp 9999` سپس `adb reverse tcp:9999 tcp:9999` |
| کلاینت تست      | `python usb_serial_simulator.py --test COM5` |

بعد از اجرای تست، خروجی باید شامل `2 passed, 0 failed` باشد.

# رکوئست‌های ارسالی به میکروکنترلر به تفکیک صفحه

این سند تمام درخواست‌ها و دستوراتی را که از اپ به میکروکنترلر ارسال می‌شوند، به تفکیک صفحه/جریان کاری لیست می‌کند. **اتصال به میکرو فقط از طریق USB Serial انجام می‌شود.**

---

## فهرست

1. [خلاصه پروتکل و فریم](#خلاصه-پروتکل-و-فریم)
2. [جدول مرجع سریع (همهٔ رشته‌ها)](#جدول-مرجع-سریع-همهٔ-رشته‌ها)
3. [صفحه اتصال سریال](#۱-صفحه-اتصال-سریال-serial-connection)
4. [داشبورد پیشرفته](#۲-داشبورد-پیشرفته-advanced-dashboard)
5. [بارگذاری طبقات و اتاق‌ها](#۳-بارگذاری-لیست-طبقات--۴-ایجاد-طبقه--۵-بارگذاری-اتاق‌ها)
6. [پنل USB و دستورات سناریو](#۶-پنل-usb--۷-دستورات-سناریو)
7. [فرمت پاسخ‌های میکرو](#فرمت-پاسخ‌های-میکرو)
8. [تست با شبیه‌ساز پایتون](#تست-با-شبیه‌ساز-پایتون)
9. [جمع‌بندی](#جمع‌بندی-به-تفکیک-کانال)

---

## خلاصه پروتکل و فریم

- **لایه انتقال:** هر پیام داخل یک **فریم** ارسال می‌شود:
  - `[STX][Type][Length][Data...][Checksum][ETX]`
  - **STX** = 0x02، **ETX** = 0x03، **Checksum** = (Type + Length + جمع بایت‌های Data) & 0xFF
- **انواع پیام (Type):** Command=0x01، Request=0x02، Response=0x03، Heartbeat=0x04، PushState=0x05
- **ACK/NAK:** میکرو بعد از دریافت فریم معتبر می‌تواند `[STX][ACK][ETX]` (0x06) یا `[STX][NAK][ETX]` (0x15) بفرستد.

تعریف ثابت‌ها و کد انکد/دیکد فریم:
- `lib/core/constants/usb_serial_constants.dart`
- `lib/core/utils/usb_serial_protocol.dart`

**پیشوندهای محتوایی (دادهٔ داخل فریم):**
- **دستور (Command):** `&`
- **درخواست (Request):** `@`
- **کد خط (Headline):** چراغ `U`، پرده `V`، دما `W`، سناریو/موزیک `X`، دوربین `X2`، دزدگیر `X1`، پریز `Y`، آسانسور `E`، قفل در `L`

---

## جدول مرجع سریع (همهٔ رشته‌ها)

| رکوئست/دستور | رشتهٔ ارسالی از اپ | توضیح کوتاه |
|---------------|---------------------|-------------|
| درخواست IP | `@M_IP` | پیکربندی IP |
| تعداد طبقات | `@M_F_C` | تعداد طبقات |
| یک طبقه | `@M_F_` + شماره | مثلاً `@M_F_1` |
| لیست طبقات | `@M_F_A` | پاسخ: خطوط id\|name\|order\|roomIds |
| ایجاد طبقه | `&M_F_N` + `\n` + خط | خط = id\|name\|order\|roomIds |
| به‌روزرسانی طبقه | `&M_F_U` + `\n` + خط | همان فرمت |
| حذف طبقه | `&M_F_D` + `\n` + floorId | |
| لیست اتاق‌ها | `@M_R` | پاسخ: خطوط id\|name\|order\|floorId\|icon\|deviceIds\|isGeneral |
| ایجاد اتاق | `&M_R_N` + `\n` + خط | خط = id\|name\|order\|floorId\|icon\|deviceIds\|isGeneral |
| به‌روزرسانی اتاق | `&M_R_U` + `\n` + خط | همان فرمت |
| حذف اتاق | `&M_R_D` + `\n` + roomId | |
| چراغ روشن/خاموش | `&U` + deviceId + `1`/`0` | |
| چراغ رنگ | `&U` + deviceId + RRGGBB | هگز بدون # |
| چراغ روشنایی | `&U` + deviceId + ۰۰۰..۱۰۰ | ۳ رقم |
| پرده باز | `&V` + deviceId + `O` | |
| پرده بسته | `&V` + deviceId + `C` | |
| پرده توقف | `&V` + deviceId + `S` | |
| پرده موقعیت | `&V` + deviceId + ۰۰۰..۱۰۰ یا O/C | |
| دما | `&W` + deviceId + ۱۰..۳۵ یا A/C/H | دما ۲ رقم؛ حالت Auto/Cool/Heat |
| موزیک پخش/توقف | `&X` + deviceId + `P`/`S` | |
| موزیک قبلی/بعدی | `&X` + deviceId + `PREV`/`NEXT` | |
| موزیک صدا | `&X` + deviceId + `VOL` + ۰۰۰..۱۰۰ | |
| دزدگیر | `&X1` + deviceId + `1`/`0` | |
| آسانسور | `&E` + deviceId + `C` + شماره طبقه | |
| قفل در | `&L` + deviceId + `L`/`U` | قفل/باز |
| آیفون/دوربین | `&X2` + deviceId + `1`/`0` | |
| پریز روشن/خاموش | `&Y` + deviceId + `1`/`0` | |
| پریز شارژ/دی‌شارژ | `&Y` + deviceId + `C`/`D` | |
| سناریو عمومی | `!&` + scenarioId | |
| سناریو طبقه | `!^` + scenarioId | |
| سناریو مکان | `!~` + scenarioId | |

---

## ۱. صفحه اتصال سریال (Serial Connection)

**فایل:** `lib/presentation/views/socket_connection_view.dart`  
**ارسال به میکرو از طریق:** USB Serial

این صفحه برای اتصال USB و دستورات تست است (درخواست IP، تعداد طبقات، چراغ، پرده، پریز، شارژ/دی‌شارژ).

| رکوئست / دستور | ثابت / فرمت | توضیح |
|----------------|-------------|--------|
| درخواست پیکربندی IP | `@M_IP` | Request IP Config |
| درخواست تعداد طبقات | `@M_F_C` | Request Floors Count |
| روشن کردن چراغ (دستگاه ۱) | `&U1` + `1` یا `0` | Turn On/Off Light |
| باز کردن پرده (دستگاه ۱) | `&V1O` | Open Curtain (`O`=Open) |
| شارژ تبلت (دستگاه ۱) | `&Y1C` | Socket Charge |
| دی‌شارژ تبلت (دستگاه ۱) | `&Y1D` | Socket Discharge |
| پریز روشن (دستگاه ۱) | `&Y1` + `1` یا `0` | Socket On/Off |

---

## ۲. داشبورد پیشرفته (Advanced Dashboard)

**فایل:** `lib/presentation/views/advanced_dashboard_view.dart`  
**ارسال به میکرو از طریق:** USB Serial (فقط وقتی USB متصل است)

دستورات از طریق کارت‌های داشبورد و `DashboardViewModel.updateCardData` → `_sendUsbSerialCommands` و ویجت‌های کارت (مثل موزیک قبلی/بعدی) ارسال می‌شوند.

### ۲.۱ چراغ (Light / LED)

| رکوئست | فرمت | محل فراخوانی |
|--------|------|----------------|
| روشن/خاموش | `&U` + `deviceId` + `1`/`0` | کارت چراغ – تغییر وضعیت |
| رنگ LED | `&U` + `deviceId` + `RRGGBB` (hex بدون #) | کارت چراغ – تغییر رنگ |
| میزان روشنایی | `&U` + `deviceId` + `000`..`100` (۳ رقم) | کارت چراغ – تغییر brightness |

### ۲.۲ پرده (Curtain)

| رکوئست | فرمت | محل فراخوانی |
|--------|------|----------------|
| باز/بسته/توقف | `&V` + `deviceId` + `O` / `C` / `S` | کارت پرده – دکمه باز/بسته |
| موقعیت (۰–۱۰۰) | `&V` + `deviceId` + `000`..`100` یا `O`/`C` | کارت پرده – اسلایدر موقعیت |

### ۲.۳ ترموستات / کولر (Thermostat / Air Conditioner)

| رکوئست | فرمت | محل فراخوانی |
|--------|------|----------------|
| دمای هدف | `&W` + `deviceId` + `10`..`35` (۲ رقم) | کارت ترموستات – تغییر دما |
| حالت (Auto/Cool/Heat) | `&W` + `deviceId` + `A`/`C`/`H` | کارت ترموستات – تغییر mode |

### ۲.۴ موزیک (Music)

| رکوئست | فرمت | محل فراخوانی |
|--------|------|----------------|
| پخش/توقف | `&X` + `deviceId` + `P` / `S` | کارت موزیک – Play/Pause |
| قبلی | `&X` + `deviceId` + `PREV` | دکمه قبلی در کارت موزیک |
| بعدی | `&X` + `deviceId` + `NEXT` | دکمه بعدی در کارت موزیک |
| صدا (۰–۱۰۰) | `&X` + `deviceId` + `VOL` + `000`..`100` | کارت موزیک – اسلایدر صدا |

### ۲.۵ امنیت / دزدگیر (Security)

| رکوئست | فرمت | محل فراخوانی |
|--------|------|----------------|
| فعال/غیرفعال | `&X1` + `deviceId` + `1` / `0` | کارت امنیت – Arm/Disarm |

### ۲.۶ آسانسور (Elevator)

| رکوئست | فرمت | محل فراخوانی |
|--------|------|----------------|
| فراخوانی به طبقه | `&E` + `deviceId` + `C` + `targetFloor` | کارت آسانسور – انتخاب طبقه |

### ۲.۷ قفل در (Door Lock)

| رکوئست | فرمت | محل فراخوانی |
|--------|------|----------------|
| قفل/باز کردن | `&L` + `deviceId` + `L` / `U` | کارت قفل در |

### ۲.۸ آیفون / دوربین (iPhone / Camera)

| رکوئست | فرمت | محل فراخوانی |
|--------|------|----------------|
| فعال/غیرفعال | `&X2` + `deviceId` + `1` / `0` | کارت آیفون |

### ۲.۹ دستگاه‌های ساده (TV, Fan, Window, Door, Humidifier, Camera و پیش‌فرض)

| رکوئست | فرمت | محل فراخوانی |
|--------|------|----------------|
| روشن/خاموش | `&Y` + `deviceId` + `1` / `0` | کارت‌های دستگاه ساده و پیش‌فرض |

### ۲.۱۰ شارژ/دی‌شارژ تبلت (در کارت‌ها)

| رکوئست | فرمت | محل فراخوانی |
|--------|------|----------------|
| شارژ | `&Y` + `deviceId` + `C` | کارت با داده `isCharging` |
| دی‌شارژ | `&Y` + `deviceId` + `D` | کارت با داده `isDischarging` |

---

## ۳. بارگذاری لیست طبقات

**فراخوانی:** `FloorViewModel.loadFloors()` → `FloorRepository.getAllFloors()`  
**استفاده در:** انتخاب طبقه، داشبورد (فیلتر طبقه)، جریان راه‌اندازی.

**ارسال به میکرو از طریق:** USB Serial (فقط وقتی USB متصل است)

| رکوئست | ثابت | پاسخ مورد انتظار |
|--------|------|-------------------|
| درخواست لیست طبقات | `@M_F_A` | متن چندخطی؛ هر خط: `id\|name\|order\|roomIds` (roomIds با کاما جدا) |

---

## ۴. ایجاد طبقه جدید (Create Floor)

**فراخوانی:** `FloorViewModel` → `FloorRepository.createFloor()`  
**ارسال به میکرو از طریق:** USB Serial (فقط وقتی USB متصل است)

| رکوئست | فرمت | توضیح |
|--------|------|--------|
| ایجاد طبقه در میکرو | `&M_F_N` + `\n` + یک خط | خط: `id\|name\|order\|roomIds` (roomIds با کاما) |

---

## ۵. بارگذاری لیست اتاق‌ها (Rooms)

**فراخوانی:** `RoomViewModel.loadRooms()` → `RoomRepository.getAllRooms()`  
**استفاده در:** داشبورد، راه‌اندازی اتاق.

**ارسال به میکرو از طریق:** USB Serial (فقط وقتی USB متصل است)

| رکوئست | ثابت | پاسخ مورد انتظار |
|--------|------|-------------------|
| درخواست لیست اتاق‌ها | `@M_R` | متن چندخطی؛ هر خط: `id\|name\|order\|floorId\|icon\|deviceIds\|isGeneral` |

---

## ۶. پنل وضعیت USB Serial (روی داشبورد)

**فایل:** `lib/presentation/widgets/dashboard/usb_serial_status_panel.dart`

در این پنل فقط **اتصال/قطع USB** انجام می‌شود؛ هیچ دستور تستی از این پنل به میکرو ارسال نمی‌شود. دستورات واقعی از طریق کارت‌های داشبورد (بخش ۲) ارسال می‌شوند.

---

## ۷. دستورات سناریو (ارسال به میکرو)

**لایه دامین:** `SendUsbSerialCommandUseCase.sendScenarioCommand(scenarioId, type)`

| نوع | فرمت |
|-----|------|
| General | `!&` + `scenarioId` |
| Floor | `!^` + `scenarioId` |
| Place | `!~` + `scenarioId` |

**نکته:** در UI فعلی، اجرای سناریو (`executeScenario`) فقط state دستگاه‌ها را در اپ به‌روز می‌کند و این دستورات را مستقیماً به میکرو نمی‌فرستد. در صورت نیاز به اجرای سناریو در سمت میکرو، می‌توان این متدها را فراخوانی کرد.

---

## ۸. درخواست یک طبقه (Request A Floor)

**ثابت:** `@M_F_` + شماره طبقه (مثلاً `@M_F_1`)

در `SendUsbSerialCommandUseCase.requestFloor(floorNumber)` موجود است؛ در UI فعلی دکمهٔ مستقیم برای آن وجود ندارد.

---

## فرمت پاسخ‌های میکرو

اپ انتظار دارد پاسخ‌های متنی (بدون JSON) با جداکننده‌های زیر باشد:

- **جداکننده فیلد:** `|`
- **جداکننده رکورد (خط):** `\n`
- **جداکننده لیست (مثلاً roomIds):** `,`

### پاسخ لیست طبقات (`@M_F_A`)

هر خط یک طبقه:  
`id|name|order|roomIds`  
مثال: `floor_1|طبقه اول|0|room_living,room_kitchen`

### پاسخ لیست اتاق‌ها (`@M_R`)

هر خط یک اتاق:  
`id|name|order|floorId|icon|deviceIds|isGeneral`  
- `isGeneral`: `1` یا `0` (متن)

پارس این پاسخ‌ها در اپ:  
`lib/data/repositories/implementations/usb_serial_repository_impl.dart` (توابع `_parseFloorsText` و `_parseRoomsText`).

---

## تست با شبیه‌ساز پایتون

برای تست بدون میکرو واقعی از اسکریپت **`scripts/usb_serial_simulator.py`** استفاده کنید:

- **شبیه‌ساز (سرور):**  
  `python usb_serial_simulator.py COM3`  
  به درخواست‌های `@M_F_A` و `@M_R` و دستور `&M_F_N` پاسخ می‌دهد.
- **کلاینت تست:**  
  `python usb_serial_simulator.py --test COM4`  
  (با جفت پورت مجازی، مثلاً com0com در ویندوز)

راهنمای کامل تست: **`scripts/README_TESTING.md`**

---

## جمع‌بندی به تفکیک کانال

| کانال | صفحات/جریان‌های مرتبط |
|-------|------------------------|
| **USB Serial** | تنها کانال اتصال به میکرو: صفحه اتصال سریال، داشبورد (همه کارت‌ها)، بارگذاری طبقات، بارگذاری اتاق‌ها، ایجاد طبقه در میکرو. |

تمامی ثابت‌های رشته‌ای در `lib/core/constants/usb_serial_constants.dart` تعریف شده‌اند و منطق ارسال در `lib/domain/use_cases/send_usb_serial_command_use_case.dart` و `lib/data/repositories/implementations/usb_serial_repository_impl.dart` قرار دارد.

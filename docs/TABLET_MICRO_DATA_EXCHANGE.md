# تبادل دادهٔ تبلت ↔ میکروکنترلر (صفحه‌به‌صفحه با مثال)

این سند **همهٔ اطلاعاتی** که بین اپ خانهٔ هوشمند سودن (روی تبلت) و میکروکنترلر از طریق **USB Serial** رد و بدل می‌شود را به‌صورت صفحه‌به‌صفحه و با **مثال‌های واقعی** شرح می‌دهد.

---

## فهرست

1. [فرمت فریم و بایت‌ها](#۱-فرمت-فریم-و-بایت‌ها)
2. [انواع پیام و جهت ارسال](#۲-انواع-پیام-و-جهت-ارسال)
3. [درخواست‌های تبلت و پاسخ میکرو](#۳-درخواست‌های-تبلت-و-پاسخ-میکرو)
4. [دستورات تبلت به میکرو (طبقات و اتاق‌ها)](#۴-دستورات-تبلت-به-میکرو-طبقات-و-اتاق‌ها)
5. [دستورات دستگاه‌ها (چراغ، پرده، پریز، …)](#۵-دستورات-دستگاه‌ها)
6. [سناریو، Heartbeat و ACK/NAK](#۶-سناریو-heartbeat-و-acknak)
7. [جداکننده‌ها و فرمت متن](#۷-جداکننده‌ها-و-فرمت-متن)

---

## ۱. فرمت فریم و بایت‌ها

**همهٔ پیام‌ها** (از تبلت به میکرو و از میکرو به تبلت) داخل یک **فریم** با ساختار زیر ارسال می‌شوند:

```
[STX][Type][Length][Data...][Checksum][ETX]
```

| فیلد       | طول (بایت) | مقدار / محاسبه |
|------------|------------|-----------------|
| **STX**    | 1          | `0x02` (Start of Text) |
| **Type**   | 1          | نوع پیام (۰x۰۱ تا ۰x۱۵) |
| **Length** | 1          | طول داده (تعداد بایت‌های Data) |
| **Data**   | Length     | دادهٔ خام (رشتهٔ UTF-8) |
| **Checksum** | 1        | `(Type + Length + sum(Data bytes)) & 0xFF` |
| **ETX**    | 1          | `0x03` (End of Text) |

### مثال بایت‌به‌بایت: ارسال درخواست لیست طبقات از تبلت

- **Data** (متن): `@M_F_A` → بایت‌ها: `0x40, 0x4D, 0x5F, 0x46, 0x5F, 0x41` (۶ بایت)
- **Type** = Request = `0x02`
- **Length** = 6
- **Checksum** = (0x02 + 6 + 0x40+0x4D+0x5F+0x46+0x5F+0x41) & 0xFF

**فریم کامل (هگز):**
```
02 02 06 40 4D 5F 46 5F 41 [checksum] 03
```

---

## ۲. انواع پیام و جهت ارسال

| Type (hex) | نام        | جهت           | توضیح |
|------------|------------|----------------|--------|
| 0x01       | Command    | تبلت → میکرو  | دستور اجرایی (چراغ، پرده، طبقه، اتاق، …) |
| 0x02       | Request    | تبلت → میکرو  | درخواست داده (لیست طبقات، اتاق‌ها، IP، …) |
| 0x03       | Response   | میکرو → تبلت  | پاسخ متنی به Request |
| 0x04       | Heartbeat  | تبلت → میکرو  | پینگ (هر ~۱ ثانیه) |
| 0x05       | PushState  | میکرو → تبلت  | (اختیاری) ارسال وضعیت از میکرو |
| 0x06       | ACK        | میکرو → تبلت  | تأیید دریافت فریم معتبر |
| 0x15       | NAK        | میکرو → تبلت  | عدم تأیید (خطا یا داده نامعتبر) |

**فریم ACK/NAK فقط ۳ بایت:**  
`[STX][0x06 یا 0x15][ETX]`  
مثال ACK: `02 06 03`  
مثال NAK: `02 15 03`

---

## ۳. درخواست‌های تبلت و پاسخ میکرو

همهٔ این‌ها با **فریم Request (Type=0x02)** از تبلت فرستاده می‌شوند و میکرو با **فریم Response (Type=0x03)** پاسخ می‌دهد.

### ۳.۱ درخواست پیکربندی IP

| طرف   | Type  | Data (متن) | مثال |
|-------|-------|------------|------|
| تبلت  | 0x02  | `@M_IP`    | درخواست تنظیمات IP |
| میکرو | 0x03  | متن IP/پیکربندی | مثلاً یک خط حاوی آدرس IP |

**مثال فریم Request از تبلت:**  
Data = `@M_IP` (۵ بایت) → فریم: `02 02 05 40 4D 5F 49 50 [CS] 03`

---

### ۳.۲ درخواست تعداد طبقات

| طرف   | Type  | Data (متن) | مثال |
|-------|-------|------------|------|
| تبلت  | 0x02  | `@M_F_C`   | درخواست تعداد طبقات |
| میکرو | 0x03  | یک عدد (مثلاً یک خط) | مثلاً `3` |

**مثال Data پاسخ:** `3`

---

### ۳.۳ درخواست دادهٔ یک طبقه (با شماره)

| طرف   | Type  | Data (متن) | مثال |
|-------|-------|------------|------|
| تبلت  | 0x02  | `@M_F_` + شماره | مثلاً `@M_F_1` برای طبقهٔ ۱ |
| میکرو | 0x03  | یک خط به فرمت طبقه | `id|name|order|roomIds` |

**مثال Data درخواست:** `@M_F_1`  
**مثال Data پاسخ:** `floor_1|طبقه اول|0|room_a,room_b`

---

### ۳.۴ درخواست لیست همهٔ طبقات

| طرف   | Type  | Data (متن) | مثال |
|-------|-------|------------|------|
| تبلت  | 0x02  | `@M_F_A`   | درخواست لیست طبقات |
| میکرو | 0x03  | چند خط؛ هر خط یک طبقه | هر خط: `id\|name\|order\|roomIds` |

**مثال Data درخواست:** `@M_F_A`  

**مثال Data پاسخ (چند خط با `\n`):**
```
floor_1|طبقه اول|0|room_living,room_kitchen
floor_2|طبقه دوم|1|room_bed1,room_bed2
```

---

### ۳.۵ درخواست لیست اتاق‌های یک طبقه

تبلت **شناسهٔ طبقه (floorId)** را می‌فرستد؛ میکرو فقط **اتاق‌های همان طبقه** را برمی‌گرداند.

| طرف   | Type  | Data (متن) | مثال |
|-------|-------|------------|------|
| تبلت  | 0x02  | `@M_R` + floorId | مثلاً `@M_Rfloor_1` برای اتاق‌های طبقهٔ floor_1 |
| میکرو | 0x03  | چند خط؛ هر خط یک اتاق (فقط اتاق‌های آن طبقه) | هر خط: `id\|name\|order\|floorId\|icon\|deviceIds\|isGeneral` |

**مثال Data درخواست:** `@M_Rfloor_1`  

**مثال Data پاسخ (فقط اتاق‌های floor_1):**
```
room_living|اتاق نشیمن|0|floor_1|living||0
room_kitchen|آشپزخانه|1|floor_1|kitchen|light_1,light_2|0
```

(فیلد خالی `deviceIds` با دو پایپ پشت‌سرهم `||` نشان داده شده؛ `isGeneral` برابر ۰ یا ۱ است.)

---

## ۴. دستورات تبلت به میکرو (طبقات و اتاق‌ها)

همهٔ دستورات این بخش داخل **فریم Command (Type=0x01)** و فیلد **Data** به‌صورت رشتهٔ متنی ارسال می‌شوند. در صورت چندبخشی بودن با `\n` (newline) جدا می‌شوند.

### ۴.۱ ایجاد طبقه

| ارسال از تبلت | Data (متن) | مثال |
|----------------|------------|------|
| Command 0x01   | `&M_F_N` + `\n` + یک خط | خط = `id\|name\|order\|roomIds` |

**مثال Data کامل:**
```
&M_F_N
floor_1|طبقه اول|0|room_a,room_b
```

---

### ۴.۲ به‌روزرسانی طبقه

| ارسال از تبلت | Data (متن) | مثال |
|----------------|------------|------|
| Command 0x01   | `&M_F_U` + `\n` + یک خط | همان فرمت خط؛ میکرو رکورد با همان id را به‌روز می‌کند |

**مثال Data:**
```
&M_F_U
floor_1|طبقه اول (ویرایش)|0|room_a,room_b,room_c
```

---

### ۴.۳ حذف طبقه

| ارسال از تبلت | Data (متن) | مثال |
|----------------|------------|------|
| Command 0x01   | `&M_F_D` + `\n` + floorId | یا `&M_F_D` + floorId در همان خط |

**مثال Data:**  
`&M_F_D\nfloor_1` یا `&M_F_Dfloor_1`

---

### ۴.۴ ایجاد اتاق

| ارسال از تبلت | Data (متن) | مثال |
|----------------|------------|------|
| Command 0x01   | `&M_R_N` + `\n` + یک خط | خط = `id\|name\|order\|floorId\|icon\|deviceIds\|isGeneral` |

**مثال Data:**
```
&M_R_N
room_1|اتاق نشیمن|0|floor_1|living||0
```

---

### ۴.۵ به‌روزرسانی اتاق

| ارسال از تبلت | Data (متن) |
|----------------|------------|
| Command 0x01   | `&M_R_U` + `\n` + یک خط (همان فرمت ایجاد) |

**مثال Data:**  
`&M_R_U` + `\n` + `room_1|اتاق نشیمن|0|floor_1|living|light_1,light_2|0`

---

### ۴.۶ حذف اتاق

| ارسال از تبلت | Data (متن) |
|----------------|------------|
| Command 0x01   | `&M_R_D` + `\n` + roomId |

**مثال Data:** `&M_R_D\nroom_1`

---

## ۵. دستورات دستگاه‌ها

همهٔ دستورات زیر داخل **فریم Command (Type=0x01)** و در **Data** به‌صورت یک رشتهٔ متنی ارسال می‌شوند.  
قالب کلی: **پیشوند دستور + deviceId + مقدار/کد**.

### ۵.۱ چراغ (Headline `U`)

| دستور تبلت | Data (مثال) | معنای دستور |
|------------|-------------|--------------|
| روشن       | `&U11`      | روشن کردن دستگاه با id=1 |
| خاموش      | `&U10`      | خاموش کردن دستگاه با id=1 |
| رنگ        | `&U1FF0000` | تنظیم رنگ قرمز (هگز بدون #) |
| روشنایی    | `&U1050`    | روشنایی ۵۰٪ (۳ رقم ۰۰۰–۱۰۰) |

**مثال‌های واقعی از اپ:**  
- چراغ ۱ روشن: Data = `&U11`  
- چراغ ۲ خاموش: Data = `&U20`  
- رنگ نارنجی برای چراغ ۱: Data = `&U1FF9500`  
- روشنایی ۷۵٪: Data = `&U1075`

---

### ۵.۲ پرده (Headline `V`)

| دستور تبلت | Data (مثال) | معنای دستور |
|------------|-------------|--------------|
| باز        | `&V1O`      | باز کردن پرده دستگاه ۱ |
| بسته       | `&V1C`      | بستن پرده |
| توقف       | `&V1S`      | توقف |
| موقعیت     | `&V1050`    | موقعیت ۵۰٪ (عدد سه‌رقمی ۰۰۰–۱۰۰) |

**مثال‌ها:**  
- باز: `&V1O`  
- بسته: `&V1C`  
- موقعیت ۲۵٪: `&V1025`

---

### ۵.۳ ترموستات / دما (Headline `W`)

| دستور تبلت | Data (مثال) | معنای دستور |
|------------|-------------|--------------|
| دمای هدف   | `&W122`     | دمای هدف ۲۲ درجه (۲ رقم ۱۰–۳۵) |
| حالت Auto  | `&W1A`      | حالت خودکار |
| حالت Cool  | `&W1C`      | حالت خنک |
| حالت Heat  | `&W1H`      | حالت گرم |

**مثال‌ها:**  
- دمای ۲۴: Data = `&W124`  
- حالت Auto: Data = `&W1A`

---

### ۵.۴ موزیک / سناریو (Headline `X`)

| دستور تبلت | Data (مثال) | معنای دستور |
|------------|-------------|--------------|
| پخش       | `&X1P`      | پخش |
| توقف      | `&X1S`      | توقف |
| قبلی      | `&X1PREV`   | آهنگ قبلی |
| بعدی      | `&X1NEXT`   | آهنگ بعدی |
| صدا       | `&X1VOL080` | صدا ۸۰٪ (۳ رقم بعد از VOL) |

**مثال‌ها:**  
- پخش: `&X1P`  
- صدا ۵۰: `&X1VOL050`

---

### ۵.۵ دزدگیر (Headline `X1`)

| دستور تبلت | Data (مثال) | معنای دستور |
|------------|-------------|--------------|
| فعال       | `&X111`     | Armed |
| غیرفعال   | `&X110`     | Disarmed |

**مثال:** فعال: Data = `&X111`

---

### ۵.۶ دوربین / آیفون (Headline `X2`)

| دستور تبلت | Data (مثال) | معنای دستور |
|------------|-------------|--------------|
| فعال       | `&X211`     | روشن/فعال |
| غیرفعال   | `&X210`     | خاموش |

---

### ۵.۷ آسانسور (Headline `E`)

| دستور تبلت | Data (مثال) | معنای دستور |
|------------|-------------|--------------|
| فراخوانی   | `&E1C2`     | فراخوانی به طبقهٔ ۲ (بعد از C شماره طبقه) |

**مثال:** فراخوانی به طبقه ۳: Data = `&E1C3`

---

### ۵.۸ قفل در (Headline `L`)

| دستور تبلت | Data (مثال) | معنای دستور |
|------------|-------------|--------------|
| قفل       | `&L1L`      | قفل کردن |
| باز       | `&L1U`      | باز کردن (Unlock) |

---

### ۵.۹ پریز / شارژر (Headline `Y`)

| دستور تبلت | Data (مثال) | معنای دستور |
|------------|-------------|--------------|
| روشن       | `&Y11`      | روشن |
| خاموش     | `&Y10`      | خاموش |
| شارژ       | `&Y1C`      | حالت شارژ |
| دی‌شارژ    | `&Y1D`      | دی‌شارژ |

**مثال‌ها:**  
- پریز ۱ روشن: `&Y11`  
- شارژ: `&Y1C`

---

## ۶. سناریو، Heartbeat و ACK/NAK

### ۶.۱ دستورات سناریو (از تبلت به میکرو)

همه در **فریم Command (Type=0x01)** و فقط **Data** فرق می‌کند:

| نوع سناریو | Data (مثال) | توضیح |
|------------|-------------|--------|
| عمومی      | `!&scenario_1` | سناریو عمومی با id داده‌شده |
| طبقه       | `!^floor_scenario_1` | سناریو مخصوص طبقه |
| مکان       | `!~place_1` | سناریو مکان |

**مثال‌های واقعی:**  
- اجرای سناریو عمومی با id `home_away`: Data = `!&home_away`  
- سناریو طبقه: Data = `!^floor_1_night`

---

### ۶.۲ Heartbeat (تبلت → میکرو)

تبلت هر حدود **۱ ثانیه** یک فریم **Heartbeat (Type=0x04)** با Data ثابت می‌فرستد.

| طرف  | Type  | Data (متن) |
|------|-------|------------|
| تبلت | 0x04  | `PING`     |

**مثال فریم:**  
`02 04 04 50 49 4E 47 [CS] 03`  
(۵۰ ۴۹ ۴E ۴۷ = "PING" در ASCII)

میکرو می‌تواند این فریم را نادیده بگیرد یا با **ACK** پاسخ دهد.

---

### ۶.۳ ACK و NAK (میکرو → تبلت)

بعد از دریافت هر فریم **Command** یا **Request** معتبر، میکرو می‌تواند تأیید بفرستد:

| پیام | فریم (هگز) | معنای دستور |
|------|------------|--------------|
| ACK  | `02 06 03`  | فریم دریافت و معتبر بود |
| NAK  | `02 15 03`  | خطا یا داده نامعتبر |

تبلت بعد از ارسال Command/Request، در صورت دریافت ACK آن را «دریافت‌شده» در نظر می‌گیرد. برای **Request**، تبلت علاوه بر ACK منتظر یک فریم **Response (0x03)** با محتوای واقعی (لیست طبقات، اتاق‌ها و …) است.

---

## ۷. جداکننده‌ها و فرمت متن

در **Data** پاسخ‌های متنی و در خطوط دستورات طبقه/اتاق از جداکننده‌های زیر استفاده می‌شود:

| جداکننده   | کاراکتر | کاربرد |
|------------|----------|--------|
| فیلد      | `|` (پایپ) | جدا کردن فیلدها در یک خط |
| خط (رکورد) | `\n` (newline) | جدا کردن هر طبقه/اتاق از دیگری |
| لیست      | `,` (کاما) | جدا کردن roomIds یا deviceIds در یک فیلد |

**مثال یک خط طبقه:**  
`floor_1|طبقه اول|0|room_living,room_kitchen`

**مثال یک خط اتاق:**  
`room_living|اتاق نشیمن|0|floor_1|living||0`

---

## خلاصهٔ جریان نمونه (لیست طبقات)

1. تبلت فریم **Request** با `Type=0x02` و `Data=@M_F_A` می‌فرستد.
2. میکرو فریم را دریافت و چک می‌کند؛ در صورت معتبر بودن **ACK** (`02 06 03`) می‌فرستد.
3. میکرو یک فریم **Response** با `Type=0x03` و `Data = متن چندخطی لیست طبقات` می‌فرستد (هر خط یک طبقه با فرمت `id|name|order|roomIds`).
4. تبلت پاسخ را پارس می‌کند و لیست طبقات را نمایش می‌دهد.

جریان برای `@M_R` (لیست اتاق‌ها) مشابه است؛ فقط محتوای Data مطابق فرمت اتاق است.

---

*این سند با توجه به `MICROCONTROLLER_PROTOCOL.md`، `usb_serial_protocol.dart`، `usb_serial_constants.dart` و `send_usb_serial_command_use_case.dart` تهیه شده است.*

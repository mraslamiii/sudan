# ارتباط تبلت ↔ میکروکنترلر — نمونه‌های عملی برای برنامه‌نویس میکرو

این سند برای **برنامه‌نویس میکروکنترلر** تهیه شده و ارتباط دو طرف (تبلت و میکرو) را با **مثال‌های واقعی** و یک **سناریوی فرضی** (لیست طبقات و اتاق‌ها) توضیح می‌دهد.

---

## ۱. خلاصهٔ ارتباط

| طرف   | نقش        | ارسال / دریافت |
|-------|-------------|-----------------|
| **تبلت** | اپ خانه هوشمند | درخواست داده (Request) و دستورات (Command) **می‌فرستد**؛ پاسخ (Response) و ACK/NAK **دریافت می‌کند** |
| **میکرو** | کنترلر سخت‌افزار | Request و Command **دریافت می‌کند**؛ Response و ACK/NAK **می‌فرستد** |

- همهٔ پیام‌ها داخل **فریم** با شروع `STX (0x02)` و پایان `ETX (0x03)` هستند.

---

## ۲. فرمت فریم (خلاصه)

```
[STX][Type][Length][Data...][Checksum][ETX]
```

- **STX** = `0x02`، **ETX** = `0x03`
- **Type**: نوع پیام (مثلاً ۰x۰۲ Request، ۰x۰۳ Response، ۰x۰۱ Command)
- **Length**: طول Data به بایت
- **Data**: متن UTF-8 (مثلاً `@M_F_A` یا لیست طبقات)
- **Checksum** = `(Type + Length + sum(Data bytes)) & 0xFF`

**استثنا:** فریم **ACK** و **NAK** فقط ۳ بایت دارند:  
`[0x02][0x06][0x03]` = ACK ، `[0x02][0x15][0x03]` = NAK

---

## ۳. سناریوی فرضی: ساختمان با ۳ طبقه

فرض کنید در میکرو یک ساختمان با ساختار زیر تعریف شده است:

| طبقه   | id      | نام        | ترتیب | اتاق‌ها |
|--------|---------|------------|-------|---------|
| طبقه ۱ | floor_1 | همکف       | 0     | اتاق نشیمن، آشپزخانه |
| طبقه ۲ | floor_2 | طبقه اول   | 1     | اتاق خواب ۱، اتاق خواب ۲ |
| طبقه ۳ | floor_3 | طبقه دوم   | 2     | اتاق کار، پذیرایی |

اتاق‌ها به صورت زیر هستند:

| اتاق        | id          | نام           | floorId | دستگاه‌ها (مثال) |
|-------------|-------------|---------------|---------|-------------------|
| نشیمن      | room_living | اتاق نشیمن    | floor_1 | light_1, light_2  |
| آشپزخانه   | room_kitchen| آشپزخانه      | floor_1 | light_3           |
| خواب ۱     | room_bed1   | اتاق خواب ۱   | floor_2 | light_4           |
| خواب ۲     | room_bed2   | اتاق خواب ۲   | floor_2 | light_5           |
| کار        | room_office | اتاق کار      | floor_3 | light_6           |
| پذیرایی    | room_guest  | پذیرایی       | floor_3 | light_7           |

---

## ۴. مثال ۱: درخواست لیست طبقات

### ۴.۱ چه اتفاقی می‌افتد؟

تبلت می‌خواهد لیست طبقات را برای نمایش در اپ بگیرد. یک بار **Request** می‌فرستد و میکرو **ACK** و بعد **Response** (همان لیست) می‌فرستد.

### ۴.۲ درخواست تبلت (Request)

تبلت یک فریم با نوع **Request (0x02)** و دادهٔ متنی **`@M_F_A`** می‌فرستد.

| فیلد    | مقدار (نماد / عدد) |
|---------|---------------------|
| Type    | 0x02 (Request)      |
| Data    | `@M_F_A`            |
| Length  | 6 (تعداد بایت Data) |

**معنی `@M_F_A`:**  
- `@` = درخواست (Request)  
- `M` = حالت/ماژول  
- `F` = Floor (طبقه)  
- `A` = All (همه = لیست کامل طبقات)

**فریم کامل درخواست (هگز):**  
Checksum = (0x02 + 6 + 0x40+0x4D+0x5F+0x46+0x5F+0x41) & 0xFF = (2+6+466) & 0xFF = **0xDA**  
`02 02 06 40 4D 5F 46 5F 41 DA 03`  
(۴۰ ۴D ۵F ۴۶ ۵F ۴۱ = "@M_F_A" در ASCII)

### ۴.۳ پاسخ میکرو

**گام ۱ — پاسخ کامل میکرو (ACK):**  
میکرو بعد از دریافت و اعتبارسنجی فریم، این فریم ۳ بایتی را می‌فرستد:

```
02 06 03
```

(STX + ACK + ETX — بدون Length/Data/Checksum). یعنی: فریم دریافت شد و معتبر است.

**گام ۲ — Response (لیست طبقات):**  
میکرو یک فریم با نوع **Response (0x03)** و **Data** = متن چندخطی (هر خط یک طبقه) می‌فرستد.

**فرمت هر خط (داخل Data):**  
`id|name|order|roomIds`  
- **id**: شناسه یکتای طبقه  
- **name**: نام نمایشی  
- **order**: ترتیب نمایش (عدد)  
- **roomIds**: شناسه اتاق‌های آن طبقه، با **کاما** بدون فاصله  

هر خط با **`\n`** (newline) از خط بعد جدا می‌شود.

**مثال Data (متن پاسخ):**

```
floor_1|همکف|0|room_living,room_kitchen
floor_2|طبقه اول|1|room_bed1,room_bed2
floor_3|طبقه دوم|2|room_office,room_guest
```

**کل پیام (فریم کامل):**  
فریم = `[STX][Type][Length][Data...][Checksum][ETX]`

| بخش      | مقدار (هگز) | توضیح |
|----------|--------------|--------|
| STX      | `02`         | شروع فریم |
| Type     | `03`         | Response |
| Length   | `N`          | طول Data به بایت (N = تعداد بایت‌های متن بالا به UTF-8) |
| Data     | (بایت‌های UTF-8 متن بالا) | همان سه خط با `\n` بین خطوط |
| Checksum | `(Type + Length + sum(Data bytes)) & 0xFF` | یک بایت؛ فرمول زیر |
| ETX      | `03`         | پایان فریم |

**محاسبهٔ Checksum:**  
`Checksum = (Type + Length + جمع همهٔ بایت‌های Data) & 0xFF`  
(فقط ۸ بیت پایین؛ اگر حاصل از ۲۵۵ بیشتر شد، با ماسک 0xFF به یک بایت برمی‌گردد.)

**نمایش نمادین کل فریم (هگز):**

```
02 03 N [DD DD DD ... ] CS 03
```

- `02` = STX  
- `03` = Type (Response)  
- `N` = Length (مثلاً اگر Data حدود ۹۰ بایت باشد، N = 0x5A)  
- `[DD DD DD ...]` = بایت‌های Data (متن سه‌خطی به UTF-8؛ کاراکترهای لاتین ۱ بایت، فارسی ۲ بایت)  
- `CS` = Checksum محاسبه‌شده  
- `03` = ETX  

**مثال عددی با محاسبهٔ واقعی Checksum (Data فقط لاتین برای سادگی):**  
فرض: Data = `floor_1|floor_2|floor_3` (۲۵ بایت).

| گام | مقدار |
|-----|--------|
| Type | 0x03 = 3 |
| Length | 25 = 0x19 |
| جمع بایت‌های Data | `f`+`l`+`o`+`o`+`r`+`_`+`1`+`\|` + `f`+`l`+`o`+`o`+`r`+`_`+`2`+`\|` + `f`+`l`+`o`+`o`+`r`+`_`+`3` = 102+108+111+111+114+95+49+124 + 102+108+111+111+114+95+50+124 + 102+108+111+111+114+95+51 = **2261** |
| جمع کل (قبل از ماسک) | 3 + 25 + 2261 = **2289** |
| **Checksum** | 2289 & 0xFF = **241 = 0xF1** |

**فریم کامل (هگز):**  
`02 03 19 66 6C 6F 6F 72 5F 31 7C 66 6C 6F 6F 72 5F 32 7C 66 6C 6F 6F 72 5F 33 F1 03`

در عمل، Data شامل متن فارسی و newline است؛ Length و Checksum را باید روی **بایت‌های واقعی** همان رشته (بعد از تبدیل به UTF-8) محاسبه کنید.  
تبلت این فریم را دریافت می‌کند، Data را استخراج و پارس می‌کند و لیست طبقات را نمایش می‌دهد.

---

## ۵. مثال ۲: درخواست لیست اتاق‌های یک طبقه

تبلت **شناسهٔ طبقه (floorId)** را در درخواست می‌فرستد؛ میکرو فقط **اتاق‌های همان طبقه** را برمی‌گرداند.

### ۵.۱ درخواست تبلت

تبلت می‌خواهد لیست اتاق‌های **یک طبقهٔ مشخص** را بگیرد؛ پس **floorId** را در Data قرار می‌دهد.

| فیلد   | مقدار        |
|--------|--------------|
| Type   | 0x02 (Request) |
| Data   | `@M_R` + floorId (مثلاً `@M_Rfloor_1`) |
| Length | طول رشته (مثلاً برای `@M_Rfloor_1` برابر ۱۱ بایت) |

**معنی درخواست:**  
- `@M_R` = درخواست لیست اتاق‌ها (R = Room)  
- بعد از آن **بدون جداکننده** شناسهٔ طبقه (floorId) قرار می‌گیرد؛ مثلاً `floor_1` → کل Data = `@M_Rfloor_1`.

**فریم کامل درخواست (هگز) — مثال برای `@M_Rfloor_1`:**  
Data = `@M_Rfloor_1` → ۱۱ بایت.  
Checksum = (0x02 + 11 + sum(بایت‌های Data)) & 0xFF = (2+11+1008) & 0xFF = **0xFD**.  
`02 02 0B 40 4D 5F 52 66 6C 6F 6F 72 5F 31 FD 03`

### ۵.۲ پاسخ میکرو (کامل)

میکرو فقط اتاق‌هایی را برمی‌گرداند که **floorId** آن‌ها برابر با floorId ارسالی تبلت باشد.

**۱) ACK — پاسخ کامل:**  
`02 06 03`

**۲) Response — فرمت هر خط اتاق:**  
`id|name|order|floorId|icon|deviceIds|isGeneral`

- **id**: شناسه اتاق  
- **name**: نام  
- **order**: ترتیب  
- **floorId**: شناسه طبقهٔ این اتاق  
- **icon**: آیکون (مثلاً living, kitchen, bedroom)  
- **deviceIds**: شناسه دستگاه‌ها با کاما (اگر خالی باشد بین دو `|` چیزی نیست)  
- **isGeneral**: ۱ یا ۰ (اتاق عمومی یا نه)

**مثال Data پاسخ (فقط اتاق‌های floor_1):**

```
room_living|اتاق نشیمن|0|floor_1|living|light_1,light_2|0
room_kitchen|آشپزخانه|1|floor_1|kitchen|light_3|0
```

**کل پیام Response (فریم کامل) — مثال با یک خط لاتین (محاسبهٔ Checksum):**  
اگر Data فقط یک خط باشد (مثلاً برای تست):  
`room_1|Room1|0|floor_1|||0` → ۲۶ بایت.  
Type=0x03، Length=26=0x1A.  
جمع بایت‌های Data = ۲۵۸۱ → Checksum = (3+26+2581) & 0xFF = **0x32**.  

**فریم کامل (هگز):**  
`02 03 1A 72 6F 6F 6D 5F 31 7C 52 6F 6F 6D 31 7C 30 7C 66 6C 6F 6F 72 5F 31 7C 7C 7C 30 32 03`

برای پاسخ با چند خط، Data را به UTF-8 تبدیل کنید؛ Length و Checksum را روی بایت‌های واقعی محاسبه کنید.  
تبلت برای گرفتن اتاق‌های همهٔ طبقات، ابتدا لیست طبقات (`@M_F_A`) را می‌گیرد، سپس برای هر طبقه یک بار `@M_R`+floorId می‌فرستد و اتاق‌های آن طبقه را دریافت می‌کند.

---

## ۶. مثال ۳: دستور روشن/خاموش چراغ (Command)

تبلت دستور اجرایی می‌فرستد؛ میکرو فقط باید دستور را اجرا کند و در صورت معتبر بودن **ACK** بفرستد (نیازی به Response با محتوا نیست).

### ۶.۱ چراغ را روشن کن (دستگاه با id=1)

| طرف   | Type    | Data   | توضیح |
|-------|---------|--------|--------|
| تبلت  | 0x01 (Command) | `&U11` | U = چراغ، دستگاه ۱، ۱ = روشن |
| میکرو | —       | —      | در سخت‌افزار چراغ ۱ را روشن می‌کند؛ سپس پاسخ زیر را می‌فرستد |

**پاسخ کامل میکرو:**  
`02 06 03` (ACK)

### ۶.۲ چراغ را خاموش کن

| طرف   | Type    | Data   |
|-------|---------|--------|
| تبلت  | 0x01    | `&U10` |
| میکرو | —       | پاسخ زیر |

**پاسخ کامل میکرو:**  
`02 06 03` (ACK)

### ۶.۳ تنظیم روشنایی ۷۰٪ برای چراغ ۱

| طرف   | Data    |
|-------|---------|
| تبلت  | `&U1070` (سه رقم ۰۰۰–۱۰۰) در فریم Command (0x01) |

**پاسخ کامل میکرو:**  
`02 06 03` (ACK)

---

## ۷. مثال ۴: دستور ایجاد طبقه (Command)

وقتی کاربر از اپ یک **طبقهٔ جدید** اضافه می‌کند، تبلت این دستور را می‌فرستد.

### ۷.۱ درخواست تبلت

| Type | Data (متن چندخطی) |
|------|---------------------|
| 0x01 (Command) | خط اول: `&M_F_N` ، خط دوم: یک خط به فرمت طبقه |

**مثال Data کامل (دو خط با `\n`):**

```
&M_F_N
floor_4|طبقه سوم|3|
```

یعنی: یک طبقه با id=floor_4، نام «طبقه سوم»، order=3 و فعلاً بدون اتاق (roomIds خالی).

### ۷.۲ پاسخ میکرو و وظیفه

**پاسخ کامل میکرو:**  
`02 06 03` (ACK)

وظیفهٔ میکرو:
- فریم را پارس کند؛ اگر معتبر بود **ACK** بالا را بفرستد.
- رکورد طبقهٔ جدید را ذخیره/اعمال کند (در EEPROM/حافظه/…).

---

## ۸. جدول خلاصه: درخواست‌های تبلت و پاسخ میکرو

| درخواست تبلت (Data) | معنای درخواست | پاسخ میکرو (Data داخل Response) |
|----------------------|----------------|-----------------------------------|
| `@M_IP`              | تنظیمات IP     | یک خط متن (مثلاً آدرس IP)        |
| `@M_F_C`             | تعداد طبقات    | یک عدد در یک خط (مثلاً `3`)      |
| `@M_F_1`             | دادهٔ طبقهٔ ۱  | یک خط: `id\|name\|order\|roomIds` |
| **`@M_F_A`**         | **لیست همهٔ طبقات** | **چند خط؛ هر خط یک طبقه** (`id\|name\|order\|roomIds`) |
| **`@M_R` + floorId** (مثلاً `@M_Rfloor_1`) | **لیست اتاق‌های همان طبقه** | تبلت floorId می‌فرستد؛ میکرو **فقط اتاق‌های آن طبقه** را برمی‌گرداند. هر خط: `id\|name\|order\|floorId\|icon\|deviceIds\|isGeneral` |

**پاسخ کامل میکرو برای همهٔ درخواست‌های بالا:**  
۱) **ACK:** `02 06 03`  
۲) **Response:** یک فریم کامل به صورت `02 03 [Length] [Data به UTF-8] [Checksum] 03` — نمونهٔ عددی برای `@M_F_A` در بند ۴.۳ و برای `@M_R` در بند ۵.۲.

**پاسخ کامل میکرو برای دستورات (Command):**  
فقط **ACK:** `02 06 03` (مثل مثال‌های ۶ و ۷).

---

## ۹. جداکننده‌های متن (یادآوری)

| جداکننده | کاراکتر | کاربرد |
|-----------|----------|--------|
| فیلد     | `\|` (پایپ) | بین فیلدهای یک خط |
| خط       | `\n`       | بین هر طبقه/اتاق |
| لیست     | `,` (کاما) | بین roomIds یا deviceIds |

---

## ۱۰. جریان کامل نمونه (لیست طبقات) — خلاصه

1. تبلت فریم **Request** با `Data = @M_F_A` می‌فرستد.
2. میکرو فریم را چک می‌کند → در صورت معتبر بودن **ACK** (`02 06 03`) می‌فرستد.
3. میکرو فریم **Response** با `Type=0x03` و `Data = متن لیست طبقات` (مثل مثال بخش ۴.۳) می‌فرستد.
4. تبلت پاسخ را پارس و لیست طبقات را نمایش می‌دهد.

برای **لیست اتاق‌های یک طبقه** همان روند با `@M_R`+floorId و فرمت اتاق تکرار می‌شود؛ میکرو فقط اتاق‌های آن طبقه را برمی‌گرداند.

---

این سند مکمل `MICROCONTROLLER_PROTOCOL.md` و `TABLET_MICRO_DATA_EXCHANGE.md` است و برای ارائه به برنامه‌نویس میکرو و درک سریع ارتباط با مثال‌های عملی تهیه شده است.
